import 'package:flutter/material.dart';
import 'dart:math' as math;

/// Interactive dartboard widget that detects clicks on different segments
class InteractiveDartboard extends StatefulWidget {
  final Function(int score, String multiplier, int baseScore, Offset position) onDartThrow;
  final double size;
  final VoidCallback? onRemoveDarts;

  const InteractiveDartboard({
    super.key,
    required this.onDartThrow,
    this.size = 300,
    this.onRemoveDarts,
  });

  @override
  State<InteractiveDartboard> createState() => InteractiveDartboardState();
}

class InteractiveDartboardState extends State<InteractiveDartboard> {
  final List<Offset> dartPositions = [];

  // Standard dartboard number sequence (clockwise from top)
  static const List<int> dartboardNumbers = [
    20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5
  ];

  void removeDarts() {
    setState(() {
      dartPositions.clear();
    });
    widget.onRemoveDarts?.call();
  }

  /// Remove a single dart from the board
  /// Returns true if a dart was removed, false if board is empty
  bool removeSingleDart() {
    if (dartPositions.isEmpty) {
      return false;
    }
    setState(() {
      dartPositions.removeLast();
    });
    return true;
  }

  /// Get the current number of darts on the board
  int get dartCount => dartPositions.length;

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTapDown: (details) => _handleTap(details.localPosition),
      child: SizedBox(
        width: widget.size,
        height: widget.size,
        child: CustomPaint(
          size: Size(widget.size, widget.size),
          painter: DartboardPainter(dartPositions: List.from(dartPositions)),
        ),
      ),
    );
  }

  void _handleTap(Offset position) {
    final center = Offset(widget.size / 2, widget.size / 2);
    final dx = position.dx - center.dx;
    final dy = position.dy - center.dy;
    final distance = math.sqrt(dx * dx + dy * dy);
    final radius = widget.size / 2;
    final normalizedDistance = distance / radius;

    // Debug output
    print('Tap at: (${position.dx.toStringAsFixed(1)}, ${position.dy.toStringAsFixed(1)})');
    print('Center: (${center.dx.toStringAsFixed(1)}, ${center.dy.toStringAsFixed(1)})');
    print('Distance: ${distance.toStringAsFixed(2)}, Radius: ${radius.toStringAsFixed(2)}, Normalized: ${normalizedDistance.toStringAsFixed(3)}');

    // Add dart position to the list
    setState(() {
      dartPositions.add(position);
    });

    // Calculate angle from center (atan2 gives angle in radians)
    // In Flutter canvas: 0 = right, π/2 = down, π = left, 3π/2 = up
    // Angles increase clockwise
    double angle = math.atan2(dy, dx);

    // Determine which segment was hit
    // Painter draws segment i with: startAngle = i * segmentAngle - π/2 - segmentAngle/2
    final segmentAngle = (2 * math.pi) / 20;

    // Calculate which segment the angle falls into
    // Normalize angle to match painter's coordinate system
    double normalizedAngle = angle + math.pi / 2 + segmentAngle / 2;
    int segmentIndex = (normalizedAngle / segmentAngle).floor() % 20;
    if (segmentIndex < 0) segmentIndex += 20;

    int baseScore;
    int finalScore;
    String multiplier;

    // Determine multiplier and calculate final score based on normalized distance
    // Check bulls first (segment-independent)
    if (normalizedDistance < 0.037) {
      // Bullseye (50 points) - don't use segment
      multiplier = 'bullseye';
      finalScore = 50;
      baseScore = 50;
    } else if (normalizedDistance < 0.094) {
      // Outer bull (25 points) - don't use segment
      multiplier = 'outer_bull';
      finalScore = 25;
      baseScore = 25;
    } else {
      // Use segment for all other rings
      baseScore = dartboardNumbers[segmentIndex];

      if (normalizedDistance < 0.582) {
        // Inner single
        multiplier = 'single';
        finalScore = baseScore;
      } else if (normalizedDistance < 0.676) {
        // Triple ring (2x width)
        multiplier = 'triple';
        finalScore = baseScore * 3;
      } else if (normalizedDistance < 0.906) {
        // Outer single
        multiplier = 'single';
        finalScore = baseScore;
      } else if (normalizedDistance < 1.0) {
        // Double ring (2x width)
        multiplier = 'double';
        finalScore = baseScore * 2;
      } else {
        // Miss (outside board)
        multiplier = 'miss';
        finalScore = 0;
        baseScore = 0;
      }
    }

    print('Segment index: $segmentIndex, Base score: $baseScore, Multiplier: $multiplier, Final score: $finalScore');
    print('---');

    widget.onDartThrow(finalScore, multiplier, baseScore, position);
  }
}

/// Custom painter for the dartboard
class DartboardPainter extends CustomPainter {
  final List<Offset> dartPositions;

  const DartboardPainter({this.dartPositions = const []});

  static const List<int> dartboardNumbers = [
    20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5
  ];

  @override
  void paint(Canvas canvas, Size size) {
    final center = Offset(size.width / 2, size.height / 2);
    final radius = size.width / 2;

    // Draw outer circle (wire/frame)
    final framePaint = Paint()
      ..color = Colors.black
      ..style = PaintingStyle.stroke
      ..strokeWidth = 3;
    canvas.drawCircle(center, radius, framePaint);

    // Draw 20 segments
    for (int i = 0; i < 20; i++) {
      final startAngle = (i * 2 * math.pi / 20) - math.pi / 2 - (math.pi / 20);
      final sweepAngle = 2 * math.pi / 20;

      // Alternate colors for segments (black and white/cream)
      final bool isDark = i % 2 == 0;
      final segmentColor = isDark ? Colors.black : const Color(0xFFF5F5DC);
      final tripleColor = isDark ? Colors.red : Colors.green;
      final doubleColor = isDark ? Colors.red : Colors.green;

      // Draw double ring (outer edge: 0.906-1.0, 2x width)
      final doublePaint = Paint()
        ..color = doubleColor
        ..style = PaintingStyle.fill;
      canvas.drawArc(
        Rect.fromCircle(center: center, radius: radius),
        startAngle,
        sweepAngle,
        true,
        doublePaint,
      );

      // Cover inner part with outer single segment color (0.676-0.906)
      final outerSinglePaint = Paint()
        ..color = segmentColor
        ..style = PaintingStyle.fill;
      canvas.drawArc(
        Rect.fromCircle(center: center, radius: radius * 0.906),
        startAngle,
        sweepAngle,
        true,
        outerSinglePaint,
      );

      // Draw triple ring (0.582-0.676, 2x width)
      final triplePaint = Paint()
        ..color = tripleColor
        ..style = PaintingStyle.fill;
      canvas.drawArc(
        Rect.fromCircle(center: center, radius: radius * 0.676),
        startAngle,
        sweepAngle,
        true,
        triplePaint,
      );

      // Cover inner single (0.094-0.582)
      canvas.drawArc(
        Rect.fromCircle(center: center, radius: radius * 0.582),
        startAngle,
        sweepAngle,
        true,
        outerSinglePaint,
      );

      // Draw numbers and scores in each area
      final textAngle = startAngle + sweepAngle / 2;
      final number = dartboardNumbers[i];

      // Helper function to draw text at a specific radius
      void drawText(String text, double textRadius, Color color, double fontSize) {
        final textOffset = Offset(
          center.dx + textRadius * math.cos(textAngle),
          center.dy + textRadius * math.sin(textAngle),
        );

        final textPainter = TextPainter(
          text: TextSpan(
            text: text,
            style: TextStyle(
              color: color,
              fontSize: fontSize,
              fontWeight: FontWeight.bold,
            ),
          ),
          textDirection: TextDirection.ltr,
        );
        textPainter.layout();
        textPainter.paint(
          canvas,
          textOffset - Offset(textPainter.width / 2, textPainter.height / 2),
        );
      }

      // Draw number in outer single area (between triple and double)
      drawText(number.toString(), radius * 0.79, isDark ? Colors.white : Colors.black, 18);

      // Draw double score in double ring (center at 0.953)
      drawText((number * 2).toString(), radius * 0.953, Colors.white, 14);

      // Draw triple score in triple ring (center at 0.629)
      drawText((number * 3).toString(), radius * 0.629, Colors.white, 14);

      // Draw single score in inner single area
      drawText(number.toString(), radius * 0.38, isDark ? Colors.white : Colors.black, 16);
    }

    // Draw outer bull (25) - radius 0.094
    final outerBullPaint = Paint()
      ..color = Colors.green
      ..style = PaintingStyle.fill;
    canvas.drawCircle(center, radius * 0.094, outerBullPaint);

    // Draw bullseye (50) - radius 0.037
    final bullseyePaint = Paint()
      ..color = Colors.red
      ..style = PaintingStyle.fill;
    canvas.drawCircle(center, radius * 0.037, bullseyePaint);

    // Draw outer bull score label (25)
    final outerBullTextPainter = TextPainter(
      text: const TextSpan(
        text: '25',
        style: TextStyle(
          color: Colors.white,
          fontSize: 16,
          fontWeight: FontWeight.bold,
        ),
      ),
      textDirection: TextDirection.ltr,
    );
    outerBullTextPainter.layout();
    outerBullTextPainter.paint(
      canvas,
      Offset(
        center.dx - outerBullTextPainter.width / 2,
        center.dy + radius * 0.055,
      ),
    );

    // Draw bullseye score label (50)
    final bullseyeTextPainter = TextPainter(
      text: const TextSpan(
        text: '50',
        style: TextStyle(
          color: Colors.white,
          fontSize: 12,
          fontWeight: FontWeight.bold,
        ),
      ),
      textDirection: TextDirection.ltr,
    );
    bullseyeTextPainter.layout();
    bullseyeTextPainter.paint(
      canvas,
      Offset(
        center.dx - bullseyeTextPainter.width / 2,
        center.dy - bullseyeTextPainter.height / 2,
      ),
    );

    // Draw darts on the board
    for (final dartPos in dartPositions) {
      // Draw dart shadow
      final shadowPaint = Paint()
        ..color = Colors.black.withOpacity(0.3)
        ..maskFilter = const MaskFilter.blur(BlurStyle.normal, 3);
      canvas.drawCircle(dartPos + const Offset(2, 2), 6, shadowPaint);

      // Draw dart outer circle (metal tip)
      final dartOuterPaint = Paint()
        ..color = Colors.grey.shade700
        ..style = PaintingStyle.fill;
      canvas.drawCircle(dartPos, 6, dartOuterPaint);

      // Draw dart inner circle (colored)
      final dartInnerPaint = Paint()
        ..color = Colors.yellow
        ..style = PaintingStyle.fill;
      canvas.drawCircle(dartPos, 4, dartInnerPaint);

      // Draw dart center point
      final dartCenterPaint = Paint()
        ..color = Colors.black
        ..style = PaintingStyle.fill;
      canvas.drawCircle(dartPos, 1.5, dartCenterPaint);
    }
  }

  @override
  bool shouldRepaint(covariant DartboardPainter oldDelegate) {
    // Always repaint if dart positions have changed
    if (dartPositions.length != oldDelegate.dartPositions.length) {
      return true;
    }
    // Check if any positions changed
    for (int i = 0; i < dartPositions.length; i++) {
      if (dartPositions[i] != oldDelegate.dartPositions[i]) {
        return true;
      }
    }
    return false;
  }
}
